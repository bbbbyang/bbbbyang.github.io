<!DOCTYPE html><html lang="en"><head><meta name="generator" content="Hexo 3.9.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>The Rule of Three | Bingyang</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/7.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon-32.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">The Rule of Three</h1><a id="logo" href="/.">Bingyang</a><p class="description">总有人把你推向阳光</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> Home</i></a><a href="/archives/"><i class="fa fa-archive"> Archive</i></a><a href="/about/"><i class="fa fa-user"> About</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">The Rule of Three</h1><div class="post-meta">Jul 31, 2020<span> | </span><span class="category"><a href="/categories/C/">C++</a></span></div><div class="post-content"><p>Once I saw a comment about C++, said that if you want to check whether the programmer is experienced or not, check if he properly handled or disabled copy constructor or assign operator if he has a destructor or delete resource. I never notice this before. The essential idea of this comment is the rule of three.</p>
<blockquote>
<p>If a class requires a user-defined destructor, a user-defined copy constructor, or a user-defined copy assignment operator, it almost certainly requires all three.</p>
</blockquote>
<h5 id="Constructor-and-Destructor"><a href="#Constructor-and-Destructor" class="headerlink" title="Constructor and Destructor"></a>Constructor and Destructor</h5><p>There are three casese that copy constructor will be called which means object will be the initial value for another object.</p>
<ol>
<li>A aa = a;</li>
<li>f(A a)</li>
<li>return a;</li>
</ol>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Class A &#123;</span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">        A( <span class="keyword">int</span> size );</span><br><span class="line">        <span class="keyword">int</span> size;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>If class <code>A</code> has been defined with a copy constructor like <code>A( const&amp; A a)</code>, it mostly will call this one. What if we do not have the copy constructor? The C++ will follow default memberwise initialization rule, which means copy the data member recursively.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">A <span class="title">a</span><span class="params">( <span class="number">5</span> )</span></span>;</span><br><span class="line">A copy = a;</span><br><span class="line"><span class="comment">// no copy constructor, it will be equal to</span></span><br><span class="line">copy.len = a.len;</span><br></pre></td></tr></table></figure>
<p>Copy constructor will copy the value one by one like the last line. If we have a pointer in our class, we need to deal the memory manually. In constructor, we need to apply for memory and in destructor we need to free this memory. This class will be like below.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Class A &#123;</span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">        A( <span class="keyword">int</span> size ) &#123;</span><br><span class="line">            data = <span class="keyword">new</span> <span class="keyword">int</span>[size];</span><br><span class="line">        &#125;</span><br><span class="line">        ~A() &#123;</span><br><span class="line">            <span class="keyword">delete</span>[] data;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">int</span> size;</span><br><span class="line">        <span class="keyword">int</span>* data;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="Shallow-Copy-and-Deep-Copy"><a href="#Shallow-Copy-and-Deep-Copy" class="headerlink" title="Shallow Copy and Deep Copy"></a>Shallow Copy and Deep Copy</h5><p>Now since we have a pointer in our class, we need to manually free the memory so we have a customized destructor to handle that. What if we do not obey the rule of three, that we do not set up a customized copy constructor and override assign operator. When we assign an object to another object, the C++ compiler will call its default copy constructor. Initilize the data member recursively.<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">A <span class="title">a</span><span class="params">( <span class="number">5</span> )</span></span>;</span><br><span class="line">A copy = a;</span><br><span class="line"><span class="comment">// no copy constructor, it will be equal to</span></span><br><span class="line">copy.data = a.data;</span><br><span class="line">copy.len = a.len;</span><br></pre></td></tr></table></figure></p>
<p>However, this copy process is <em>Shallow Copy</em>, it is only copy the value of each data member. This will cause memory leak. Pointer <code>copy.data</code> and <code>A.data</code> pointing to the same chunk of memory. When we release object A, destructor of A will free this memory, after that we release object copy, the same chunk of memory will be freed again. Default copy constructor is shallow copy and it will cause memory leak problem.</p>
<p>In order to solve this, we need <em>Deep Copy</em>. Now we setup a customized copy constructor<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">A(<span class="keyword">const</span> A&amp; a) :</span><br><span class="line">&#123;</span><br><span class="line">    size = a.size</span><br><span class="line">	data = <span class="keyword">new</span> <span class="keyword">int</span>[size];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>In our copy constructor, we use deep copy, which apply for a new memory for its own pointer. When release each object, the destructor will only free the memory this object applied. Now we can see the difference of <em>Shallow Copy</em> and <em>Deep Copy</em>. </p>
<p>This also explain for the rule of three. When we have a customized destructor, that means we need to handle the memory free for the pointer. If we do not obey the rule, the default copy contructor will have a shallow copy. Rule of three force us to have a deep copy.</p>
</div><div class="tags"><a href="/tags/Deep-copy/">Deep copy</a></div><div class="post-nav"><a class="pre" href="/2021/04/20/Network-IO-Models/">Network IO Models</a><a class="next" href="/2020/05/17/C-Polymorphism/">C++ Polymorphism</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> Categories</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Algorithm/">Algorithm</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Android/">Android</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/C/">C++</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Design-Pattern/">Design Pattern</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java/">Java</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Protocol/">Protocol</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/algorithm/">algorithm</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> Tags</i></div><div class="tagcloud"><a href="/tags/DIP/" style="font-size: 15px;">DIP</a> <a href="/tags/DP/" style="font-size: 15px;">DP</a> <a href="/tags/AOP/" style="font-size: 15px;">AOP</a> <a href="/tags/HashTable/" style="font-size: 15px;">HashTable</a> <a href="/tags/Interface/" style="font-size: 15px;">Interface</a> <a href="/tags/Polymorphism/" style="font-size: 15px;">Polymorphism</a> <a href="/tags/Annotation/" style="font-size: 15px;">Annotation</a> <a href="/tags/Web-Server/" style="font-size: 15px;">Web Server</a> <a href="/tags/OAuth/" style="font-size: 15px;">OAuth</a> <a href="/tags/Mean-Shift/" style="font-size: 15px;">Mean Shift</a> <a href="/tags/TLS/" style="font-size: 15px;">TLS</a> <a href="/tags/View/" style="font-size: 15px;">View</a> <a href="/tags/Deep-copy/" style="font-size: 15px;">Deep copy</a> <a href="/tags/NIO/" style="font-size: 15px;">NIO</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> Links</i></div><ul></ul><a target="_blank"></a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer"><div><!--span#busuanzi_container_site_pv//span= ' '
//span#busuanzi_value_site_pv
//span(rel='nofollow')= ' ' + __(' HITS, ')--><span id="busuanzi_container_site_uv"><span id="busuanzi_value_site_uv"></span><span rel="nofollow">  VISITORS.</span></span></div>BINGYANG © 2022 刘冰洋 | HEADING TO THE FUTURE<br><a class="fa fa-github fa-2x" rel="nofollow" target="_blank" href="https://github.com/bbbbyang"></a> &nbsp; <a class="fa fa-linkedin fa-2x" rel="nofollow" target="_blank" href="https://www.linkedin.com/in/bingyang-liu-451b7976/"></a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.2.5/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.2.5/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script><script src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script></div></body></html>